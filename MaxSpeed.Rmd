---
title: "Maximum Speed"
author: "Daniel, Alex, Amir & Simon"
date: "Monday, November 17, 2014"
output: html_document
---
```{r}
pkgs <- c ("knitr", "rmarkdown", "yaml", "bitops", "trajectories", "plotKML", "XML", "sp", "maptools", "rgdal", "OpenStreetMap", "graphics", "grDevices", "utils", "mgcv", "rJava", "rgl", "stringr", "spacetime", "adehabitatLT", "ggplot2")
new.pkgs <- pkgs [!(pkgs %in% rownames (installed.packages()))]
if(length(new.pkgs)) install.packages(new.pkgs)
```

```{r}
require(trajectories)
require(spacetime)
require(OpenStreetMap)
require(ggplot2)
require(plotKML)
require(map3d)
require(knitr)
knit_hooks$set(rgl = hook_rgl)
```
---
First of all, we load the required data...

```{r}

## Holger's Cycle Tracks

getTr <- function (file) {
  tr <- readGPX (file)
  tr <- tr$tracks[[1]][[1]]
  crs <- CRS ("+proj=longlat")
  sp <- SpatialPoints (tr[,1:2], crs)
  t <- as.POSIXct(strptime(tr$time, "%Y-%m-%dT%H:%M:%SZ"))
  stidf <- STIDF (sp, t, data.frame (tr$ele))
  tr <- as (stidf, "Track")
  Track(tr)
}

ddir <- "dat/gpx-tracks/"
files <- list.files (ddir)
files <- as.character (sapply (files, function (x) paste (ddir, x, sep="")))

rides1 <- list ()
for (f in files) {
  cat (f, "\n")
  rides1 <- c (rides1, getTr (f))
}

holger <- TracksCollection (list (rides1=Tracks (rides1)))
```

```{r}
## Mark's Cycle Tracks

getMTr <- function (file) {
  tr <- readGPX (file)
  tr <- tr$tracks[[1]][[1]]
  crs <- CRS ("+proj=longlat")
  sp <- SpatialPoints (tr[,1:2], crs)
  t <- as.POSIXct(strptime(tr$time, "%Y-%m-%dT%H:%M:%OSZ"))
  stidf <- STIDF (sp, t, data.frame (tr$ele))
  tr <- as (stidf, "Track")
  Track(tr)
}


ddir <- "dat/gpx-tracks-mp/"
files <- list.files (ddir)
files <- as.character (sapply (files, function (x) paste (ddir, x, sep="")))
rides2 <- list ()
for (f in files) {
  cat (f, "\n")
  rides2 <- c (rides2, getMTr (f))
}

mark <- TracksCollection (list (rides2=Tracks (rides2)))
```

<br>
Simplest way to determine the highest speed value is to compare for example the 10 highest speed values of both data sets (Holger + Mark).

So we did...

```{r}
h1data <- holger@tracksCollection$rides1@tracks$Track1
h2data <- holger@tracksCollection$rides1@tracks$Track2
h3data <- holger@tracksCollection$rides1@tracks$Track3
h4data <- holger@tracksCollection$rides1@tracks$Track4
h5data <- holger@tracksCollection$rides1@tracks$Track5
h6data <- holger@tracksCollection$rides1@tracks$Track6

h <- sort(c(h1data$speed, h2data$speed, h3data$speed, h4data$speed, h5data$speed, h6data$speed))
h_10 <- c(h[(length(h)-10):length(h)])

m1data <- mark@tracksCollection$rides2@tracks$Track1
m2data <- mark@tracksCollection$rides2@tracks$Track2
m3data <- mark@tracksCollection$rides2@tracks$Track3

m <- sort(c(m1data$speed, m2data$speed, m3data$speed))
m_10 <- c(m[(length(m)-10):length(m)])
```

```{r}
h_10
m_10
```
<br>
You have to keep in mind: speed unit is metres/second!
<br> So, some values seems to be measurement errors (e.g. 124.79)...
<br>
<br>
Nevertheless, we wanted to have a closer look and analyzed how the speed values depends on the height differences in the cruised areas of both data sets.

```{r}
plotEleSpeed <- function (elevation, speed, ylim){
  x <- 1:length(speed)
  par(mar=c(5,4,4,5)+.1)
  plot(x,elevation,type="l",col="red", ylim=ylim)
  par(new=TRUE)
  plot(x, speed,,type="l",col="blue",xaxt="n",yaxt="n",xlab="",ylab="")
  axis(4)
  mtext("speed",side=4,line=3)
  legend("topleft",col=c("red","blue"),lty=1,legend=c("Elevation","Speed"))
}
```
### Holger
<br>
Holger #1
```{r}
h1conn <- h1data@connections
h1conn <- rbind(h1conn, c(0, 0, 0, 0))
h1speed <- h1conn$speed
h1elevation <- as.vector(h1data@data$tr.ele)
plotEleSpeed(h1elevation, h1speed, c(60,300))
```
<br>
Holger #2
```{r}
h2conn <- h2data@connections
h2conn <- rbind(h2conn, c(0, 0, 0, 0))
h2speed <- h2conn$speed
h2elevation <- as.vector(h2data@data$tr.ele)
plotEleSpeed(h2elevation, h2speed, c(40,115))
```
<br>
Holger #3
```{r}
h3conn <- h3data@connections
h3conn <- rbind(h3conn, c(0, 0, 0, 0))
h3speed <- h3conn$speed
h3elevation <- as.vector(h3data@data$tr.ele)
plotEleSpeed(h3elevation, h3speed, c(50,170))
```
<br>
Holger #4
```{r}
h4conn <- h4data@connections
h4conn <- rbind(h4conn, c(0, 0, 0, 0))
h4speed <- h4conn$speed
h4elevation <- as.vector(h4data@data$tr.ele)
plotEleSpeed(h4elevation, h4speed, c(45,300))
```
<br>
Holger #5
```{r}
h5conn <- h5data@connections
h5conn <- rbind(h5conn, c(0, 0, 0, 0))
h5speed <- h5conn$speed
h5elevation <- as.vector(h5data@data$tr.ele)
plotEleSpeed(h5elevation, h5speed, c(400,700))
```
<br>
Holger #6
```{r}
h6conn <- h6data@connections
h6conn <- rbind(h6conn, c(0, 0, 0, 0))
h6speed <- h6conn$speed
h6elevation <- as.vector(h6data@data$tr.ele)
plotEleSpeed(h6elevation, h6speed, c(42,110))
```
<br>
### Mark
<br>
Mark #1
```{r}
m1conn <- m1data@connections
m1conn <- rbind(m1conn, c(0, 0, 0, 0))
m1speed <- m1conn$speed
m1elevation <- as.vector(m1data@data$tr.ele)
plotEleSpeed(m1elevation, m1speed, c(55,80))
```
<br>
Mark #2
```{r}
m2conn <- m2data@connections
m2conn <- rbind(m2conn, c(0, 0, 0, 0))
m2speed <- m2conn$speed
m2elevation <- as.vector(m2data@data$tr.ele)
plotEleSpeed(m2elevation, m2speed, c(55,80))
```
<br>
Mark #3
```{r}
m3conn <- m3data@connections
m3conn <- rbind(m3conn, c(0, 0, 0, 0))
m3speed <- m3conn$speed
m3elevation <- as.vector(m3data@data$tr.ele)
plotEleSpeed(m3elevation, m3speed, c(59,190))
```
<br>
You can also use Niko's `map3d` package to visualize the attribute speed with z-axis height.
Just as a gimmick..
```{r}
p <- SpatialPointsDataFrame(h4data@sp, h4conn)
a <-as.character(h4data@data$tr.ele)
b <- as.numeric(a)
```
```{r, rgl=TRUE, fig.align = 'center',fig.height = 6}
par3d("zoom" = 0.35)

spplot3d(p, att="speed", radius = 0.2, height=b/50, open3d = FALSE, type="skobbler", col=c("green", "red"))
```
